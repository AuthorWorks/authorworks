networks:
  llm_network:
    external: true

services:
  # API Gateway
  api-gateway:
    image: nginx:alpine
    container_name: authorworks-nginx
    volumes:
      - ./nginx.conf:/etc/nginx/nginx.conf:ro
      - ./frontend/landing/leptos-app/dist:/usr/share/nginx/html:ro
    depends_on:
      - user-service
      - content-service
      - storage-service
      - editor-service
      - messaging-service
      - subscription-service
      - discovery-service
      - media-service
    networks:
      - llm_network
    healthcheck:
      test: ["CMD-SHELL", "curl -f http://localhost:8080/health || exit 1"]
      interval: 10s
      timeout: 5s
      retries: 3
      start_period: 10s
    labels:
      - "traefik.enable=true"

      # Public landing page route (no auth, highest priority)
      - "traefik.http.routers.authorworks-public.rule=Host(`authorworks.${DOMAIN}`) && PathPrefix(`/`)"
      - "traefik.http.routers.authorworks-public.entrypoints=web,websecure"
      - "traefik.http.routers.authorworks-public.priority=10"
      - "traefik.http.routers.authorworks-public.service=authorworks-service"

      # Protected app routes (with auth, lower priority)
      - "traefik.http.routers.authorworks-app.rule=Host(`authorworks.${DOMAIN}`) && (PathPrefix(`/app`) || PathPrefix(`/api`))"
      - "traefik.http.routers.authorworks-app.entrypoints=web,websecure"
      - "traefik.http.routers.authorworks-app.middlewares=authelia-cloudflare@file"
      - "traefik.http.routers.authorworks-app.priority=20"
      - "traefik.http.routers.authorworks-app.service=authorworks-service"

      # Service definition
      - "traefik.http.services.authorworks-service.loadbalancer.server.port=8080"

  user-service:
    build:
      context: ./services/user
      dockerfile: Dockerfile
    container_name: authorworks-user-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3001
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@neon-postgres-leopaska:5432/authorworks
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-nd-leopaska:6379
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
      JWT_SECRET: ${JWT_SECRET}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3001/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  content-service:
    build:
      context: ./services/content
      dockerfile: Dockerfile
    container_name: authorworks-content-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3002
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@neon-postgres-leopaska:5432/authorworks
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-nd-leopaska:6379
      STORAGE_SERVICE_URL: http://storage-service:3003
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
      ANTHROPIC_API_KEY: ${ANTHROPIC_API_KEY}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3002/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  storage-service:
    build:
      context: ./services/storage
      dockerfile: Dockerfile
    container_name: authorworks-storage-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3003
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@neon-postgres-leopaska:5432/authorworks
      MINIO_ENDPOINT: http://minio-leopaska:9000
      MINIO_ACCESS_KEY: ${MINIO_ROOT_USER}
      MINIO_SECRET_KEY: ${MINIO_ROOT_PASSWORD}
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3003/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  editor-service:
    build:
      context: ./services/editor
      dockerfile: Dockerfile
    container_name: authorworks-editor-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3004
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@neon-postgres-leopaska:5432/authorworks
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-nd-leopaska:6379
      CONTENT_SERVICE_URL: http://content-service:3002
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3004/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  subscription-service:
    build:
      context: ./services/subscription
      dockerfile: Dockerfile
    container_name: authorworks-subscription-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3005
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@neon-postgres-leopaska:5432/authorworks
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-nd-leopaska:6379
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
      STRIPE_SECRET_KEY: ${STRIPE_SECRET_KEY:-sk_test_placeholder}
      STRIPE_WEBHOOK_SECRET: ${STRIPE_WEBHOOK_SECRET:-whsec_placeholder}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3005/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  messaging-service:
    build:
      context: ./services/messaging
      dockerfile: Dockerfile
    container_name: authorworks-messaging-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3006
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-nd-leopaska:6379
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3006/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  discovery-service:
    build:
      context: ./services/discovery
      dockerfile: Dockerfile
    container_name: authorworks-discovery-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3007
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@neon-postgres-leopaska:5432/authorworks
      REDIS_URL: redis://:${REDIS_PASSWORD}@redis-nd-leopaska:6379
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
      QDRANT_URL: ${QDRANT_URL:-http://qdrant:6333}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3007/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped

  media-service:
    build:
      context: ./services/media
      dockerfile: Dockerfile
    container_name: authorworks-media-service
    environment:
      HOST: 0.0.0.0
      SERVICE_PORT: 3008
      DATABASE_URL: postgresql://postgres:${POSTGRES_PASSWORD}@neon-postgres-leopaska:5432/authorworks
      STORAGE_SERVICE_URL: http://storage-service:3003
      ALLOWED_ORIGINS: https://authorworks.${DOMAIN}
    networks:
      - llm_network
    healthcheck:
      test: ["CMD", "curl", "-f", "http://localhost:3008/health"]
      interval: 30s
      timeout: 5s
      retries: 3
    restart: unless-stopped
